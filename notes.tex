%%% Notes on this and that

\documentclass{article}

\usepackage{notes}

\addbibresource{mishmash.bib}

\title{Notes on this and that}

\hypersetup{pdftitle={Notes on this and that}}

\hypersetup{pdfsubject={This and that}}

\hypersetup{pdfkeywords={books, films, mathematics, programming,
    Himalaya, writing}}

\author{Raghavendra Nyshadham\thanks{\cczero} \\
  {\normalsize\nolinkurl{rn@raghnysh.com}}}

\hypersetup{pdfauthor={Raghavendra Nyshadham (rn@raghnysh.com)}}

\date{2024-09-28}

\begin{document}

\begin{titlingpage}
  \maketitle

  \begin{abstract}
    This document contains my notes on this and that, such as the
    books that I read, the films that I watch, and the topics in
    mathematics and programming that interest me.  I also hope to
    write about the Himalaya: the Garhwal Himalaya, some of which I
    have seen, and near whose foothills I live.  The document is a
    work in progress.  The files of the current version of the
    document are available at
    \url{https://github.com/raghnysh/mishmash}.

    \ghtopics{books, films, mathematics, programming, Himalaya,
      writing}
  \end{abstract}
\end{titlingpage}

\tableofcontents

\section{Introduction}
\label{sec:113nrd0o}

This document contains my notes on this and that, such as the books
that I read, the films that I watch, and the topics in mathematics and
programming that interest me.  I also hope to write about the
Himalaya: the Garhwal Himalaya, some of which I have seen, and near
whose foothills I live.  The document is a work in progress.  The
files of the current version of the document are available at
\url{https://github.com/raghnysh/mishmash}.

\section{Mountains may depart}
\label{sec:ov8yna0s}

I first watched this film on 26 July, 2024 on MUBI.  It is directed by
Jia Zhangke, and was made in 2015.  The main actors in the film are
Zhao Tao, Yi Zhang, Jingdong Liang, and Dong Zijian.  Tao had acted in
some of Zhangke's earlier films including \emph{A touch of sin}.

The central story of \emph{Mountains may depart} invloves a woman Shao
Tao (played by Zhao Tao), the men Jinsheng Zhang and Jangjung Liang
a.k.a Liangzi (played by Yi Zhang and Jingdong Liang), and the boy
Daole Zhang a.k.a Dollar (played by Dong Zijian).  The film is located
mostly in Fenying, where Zhangke grew up; it is a city in the Shanxi
province of North China.

\subsection{Youth}
\label{sec:jfdg3q3z}

It is 1999.  Tao is a young woman, a singer and a dancer.  She teaches
in a disco school in the city, and sings regularly at the New Year
concert.  Zhang and Liangzi are her close friends, both of them in
love with her, although she seems strangely oblivious to their
feelings.

The film opens with Tao and her students dancing to the famous Pet
Shop Boys song \emph{Go West}.  She makes waves with her hands as the
dancers move with exercise-like regularity and disappear from the
scene holding each other in single file.

Zhang is an aggressive industrial entrepreneur, and goes around
bragging about the money he makes and his fancy foreign car.  Liangzi
works as a clerk in a coal mine, keeping track of the helmets of the
miners.

Neither of the two men is reticent about his love for Tao.  She
doesn't seem to notice these emotions.  Perhaps she realises that
acknowledging their feelings would force her to choose one of them and
alienate the other.  She tries her best to steer the middle course.
So we see the three of them hanging out as Tao prepares to sing at the
New Year festival.  Zhang shows them his new car, and later takes them
for a spin in it.  They burst fireworks on the frozen Fen river.

The tense bonhomie between the three is not destined to last.  Already
on their Fen river outing, Zhang tells Tao that he would like to be
alone with her, and that he does not like their triangular tie with
Liangzi.  Tao retorts that the triangle is a stable arrangement, and
is averse to distancing herself from Liangzi.  As the fireworks light
up the sky over the white river, we see the three friends standing
away from each other, looking up from the vertices of a triangle.

When the mine that employs Liangzi goes bankrupt, Zhang buys it and
fires him.  Tao soon finds herself forced by Zhang to make a choice.
She visits Liangzi's home with an invitation to her wedding with
Zhang.  Liangzi sees that there is nothing for him in Fenyang, and
leaves the city without bidding Tao goodbye.

Zhang and Tao soon have a child, a boy they name Daole, with the
nickname Dollar in honour of Zhang's capitalist ambitions.  They also
adopt a dog, a white Labrador who Zhang says has a lifespan of 15
years.

\subsection{The middle years}
\label{sec:m1ubz2fo}

It is 2014.  Tao's Labrador, though 15 and old, is still with her.
Zhang and Dollar aren't.  Tao and Zhang got divorced, and the father
won custody of the child.  Tao continues to live in Fenyang, running a
petrol station.  Zhang has moved to Shanghai, where Dollar attends the
International School.

Liangzi has had a difficult life, a migrant labourer moving from one
back-breaking and ill-paying job to another.  He is working in a coal
mine again now, and is married with a small child.  He has acquired a
rasping cough that never seems to leave him.  It is cancer of the
lungs, but he and his devoted wife Xiao Lu (played by Liu Lu) don't
have the money for chemotherapy and medicines.

Soon Liangzi is unable to work, and the family return to his home in
Fenyang.  Unable to see his suffering, and guessing at her husband's
first love, Lu approaches Tao and asks her to help.  Tao visits them
and hands over the money for the treatment.

Liangzi disappears from the story at this juncture.  It is surprising
to see a central character going away when about half the film is yet
to go.  I assume he got better with the chemotherapy and the
medicines.  Or perhaps he died, loyal lover that he was, broken by the
harrowing and lonely years on the road.

Age is catching up with Tao.  Her father dies while visiting an old
friend in another city.  Tao travels there to bring his body back to
be cremated in Fenyang.  She speaks formally with the doctor at the
mortuary, but breaks into rending tears in front of her father's
friend.  I wonder why he didn't hold her, comfort her.  Alone, she
brings her dead father back in an ambulance.

Tao's young son visits Fenyang from Shanghai for his grandfather's
funeral.  He looks just about six, but Tao is impatient with him.  She
calls his habitual scarf girlish, and yells at him in public when he
fumbles with the funeral rituals.  She stops his phone calls to his
stepmother in Shanghai.  One feels sorry for the child, but they
realise their love for each other as she takes the train to Shanghai
with him.  He rests his head on her shoulder, and, later, sleeping on
the berth, plays with the keys to her house that she has presented
him.

\subsection{Old age}
\label{sec:7wgsj9bn}

It is 2025.  Tao is old.  Her Labrador is gone, but he seems to have
left one of his descendants, a white puppy, to look after her.

Zhang has moved his family to Melbourne (although the scenes of this
part were filmed more than 2000 miles away in Bunbury), and his second
wife also seems to have separated from him.  He has grown old, and
spends his time drinking with his Chinese-Australian friends in his
designer-home.  He doesn't know much English, and talks to his son in
Mandarin.

Dollar is now a teenager.  He goes to a posh school, doesn't speak his
mother tongue, and barely understands his father's words.  Their
relationship has turned fractious, the differences between them
exacerbated by the difficulties of Dollar's adolescence in a foreign
environment.  He is so traumatised by Tao's absence that he cannot
bear to mention her, and says that he is a test-tube baby without a
mother.

At school, Dollar has an easy equation with his friends, several of
them of Chinese origin.  Mia (played by Sylvia Chang) teaches these
children Mandarin and Chinese culture.  The kids are bright, and there
is a playful repartee between them and her in the class.

Dollar works the evenings at a Chinese restaurant, and sometimes
delivers dinner to Mia's apartment.  Over time they become close, and
fall in love with each other.  The relationship between the
middle-aged woman and the teen is at times disturbing to watch, but
Mia is good to Dollar.  She travels with him, and tells him that he
should go to Fenyang to meet Tao.  He is hesitant because of the long
separation from his mother.

The affair between Dollar and Mia soon succumbs to the difference
between their ages.  As they part from each other in Melbourne, Dollar
at last utters his mother's name, ``Tao''.

Tao is living alone in Fenyang.  We see her mincing meat in her
kitchen as she has always done.  Sometimes she hears voices calling
out her name.  She smiles at her fancies, and takes her Lab out for a
walk on the frozen Fen.

The river is much like what it was that New Year in 1999 when she
described a triangle with Zhang and Liangzi.  The water has turned to
ice again.  Tao removes the leash from her dog.  She raises her head
to the sky, and dances slowly, as she did long ago in the disco, to
Pet Shop Boys singing \emph{Go West}.  That's how the film ends.

\subsection{The song}
\label{sec:njpsvlf6}

The song \emph{Go West} by Pet Shop Boys opens the film and closes it
as well.  It was originally written and sung in 1979 by an American
disco music group called Village People.  Pet Shop Boys extended the
text of that song and released the new version in 1993.  It has
attracted much attention since then, and has been identified with gay
culture and football fandom \parencite{bib:3hf0kuo0}.

The official video of the song \parencite{bib:4dsv5d40} shows a relief
sculpture of Lenin, goose-stepping soldiers, and several other images
from the iconography of the Soviet Union.  Robot-like humans march
across a flight of stairs towards a `W' sign while a woman dressed
like the Statue of Liberty vocalises.  It sounds like a sarcastic take
on the fall of the USSR and the false promise that the capitalist West
held then for the people of the communist East.

For me, the song embodies hope, the possibility of a better time and
place than now.  Some of the lyrics that were written by Pet Shop Boys
for the song go
\begin{verse} \itshape
  There where the air is free \\
  we'll be what we want to be \\
  Now if we make a stand \\
  we'll find our promised land
\end{verse}
There is a reassurance here that collective action will give us the
happiness that we seek individually.  One of the best renditions of
the song that I have heard is by the Brythoniaid Male Voice Choir from
Wales \parencite{bib:4lizl8c7}.  The sight of old men from the choir
singing these lines \parencite{bib:n7kfye4j} suggests wistful memories
of a dream for the future.

Zhangke talks about \emph{Go West} in an interview about
\emph{Mountains may depart} \parencite{bib:zt0dmft0}.  He speaks of
how discos became common in Beijing when he was a student there in the
late 90s.  The song was played at midnight, and the dancers formed a
chain to the music as in the opening scenes of the film.  He says that
the song evokes a sense of freedom that is possible only in youth:
``When you're young and free, it doesn’t matter if you're going `west'
or elsewhere.  The important thing is the impulsiveness with which you
{`go.'}''

When I watched the closing scenes of the film, where Tao frees her dog
before dancing to the song in the snow, I thought that it was a sign
that she was going to die in the freezing cold.  Later, I learnt that
the director wants to convey something else altogether
\parencite{bib:6xz64ynw}.  Zhangke says, ``At the end of the script I
originally envisioned a day that was snowing and Tao is coming home
from getting groceries.  She hears someone call her and she turns
around and doesn’t see anybody.  Then I thought that perhaps she could
dance, because even though she’s ended up as a very lonely woman, she
still has to live on like all of us do.  In her heart there is still a
vitality and I wanted to draw that out.''

As for the most important thing in Tao's life, her son, did Dollar
overcome the pain of the childhood away from her, and travel to
Fenyang to meet her? We are not told, but I don't think he did.
Perhaps it doesn't matter anymore now, as she moves gently in the
falling snow.

\section{Blind chance}
\label{sec:7d7zho9u}

I first watched this film on 16 September, 2024 on MUBI.  It is
directed by Krzysztof Kie\'slowski, and was made in 1981.  The Polish
military, which took over the government of the country at the end of
that year, banned the film immediately after it was made
\parencite[p.~55]{bib:chlvcvbq}.  It was released with several cuts in
1987.  The current version restores all but one of the censored
portions.

The film is about a young man named Witold Duglosz a.k.a Witek (played
by Bogus\l{}aw Linda) running to catch a train from \L\'od\'z to
Warsaw, which is 120 km away from \L\'od\'z.  There are three stories
in the film, each of which describes a different sequence of events
starting with this sprint for the train.  In the first story, Witek
becomes a member of the Communist Party; in the second, he becomes a
Catholic dissident against the communist regime; and in the last
story, Witek becomes an apolitical doctor who dies in a plane crash.

Through the three possibilities, the film portrays the role of chance
in the way our lives evolve.  We often wonder what it would have been
like if we had done one thing instead of another at a critical
juncture of our lives.  These speculations are about the effect on our
lives of important choices within our control, of well-defined paths
that we deliberately choose to follow; we might, for instance, ask
ourselves, ``What would it have been like if I had studied literature
instead of mathematics?''  The film, on the other hand, is about how
random and seemingly insignificant events beyond our control have a
pivotal influence on our lives.

I think that there are forces of nature, which we do not understand in
the least, that shape our lives starting from the accidents of our
births.  The physical or mental abilities that we may have, the
personal beauty that we may display, are random gifts from nature that
it could have, with equal chance, bestowed upon someone else.  Our
lives are entirely changed, even destroyed, by unlikely events that
happen in spite of their improbability.  It looks to me as if nature,
at any point in the history of a species, allots certain amounts of
brilliance and stupidity, beauty and ugliness, joy and pain, to the
species as a whole; it is a matter of chance what an individual of the
species gets, and there is no reason for them to be proud of what they
have, or ashamed of what they do not have.  Watching \emph{Blind
  chance} reinforced these beliefs in me.

\subsection{Prelude}
\label{sec:p9c5o4iz}

The film begins with an introductory section that shows various scenes
from Witek's life.  It begins with Witek's birth in a hospital, and
ends with the his father's death.  These are the scenes of the
prelude:

\begin{enumerate}
\item Witek is born at the end of June, 1956, in Pozna\'n.  The city
  is in the midst of a strike by workers against low salaries, high
  taxes, and high prices.  Their clashes with the armed troops sent to
  quell the protest leave more than 50 strikers dead.  The medical
  staff in the hospital carry away bloody corpses.  Witek's mother and
  twin brother die during the delivery.
\item The child Witek is doing his mathematics homework under the
  guidance of his father (played by Bogdan Niewinowski).  He dips his
  pen into the inkwell, and writes, ``\(17 - 9 = 8\)''.  The figure
  \(8\) is made of a circle below another.  The father says, ``Good.
  Your mother too wrote her eights like that.''
\item The boy Witek is bidding his friend Daniel goodbye.  Daniel and
  his family are fleeing to Denmark from the persecution of Jews by
  the Polish state in 1968.  Daniel and his father walk to a car
  waiting atop a grassy slope.
\item Young Witek is peeping into a room where a political meeting is
  happening.  A young man notices him and comes to the window to wink
  at him.  Who is this young man?

  The meeting itself is surreal.  Someone says that Kubin was the
  prime minister, kissed a girl in the cloakroom the previous year,
  and can be transferred.  Another says that Duglosz was the minister
  of health, lost his mother, and has A grades in all his courses; it
  sounds like they are talking about Witek, the boy who is peeping
  into the room.

  What is this dream-like meeting in which people talk of transferring
  a prime minister, and of a health minister with A grades?  Perhaps
  school teachers rehearsing a play?  Whatever.
\item Witek is kissing a short-haired girl beside a road.  It is
  Czuszka (played by Boguslawa Pawelec), his girlfriend from school.
  A lorry drives by with men who shout profanities at them.  Witek
  runs after the lorry.
\item Witek's class in the medical college is watching the dissection
  of a cadaver.  Olga Matwiszyn (played by Monika Go\'zdzik), one of
  the students, looks uncomfortable.
\end{enumerate}

\section{Using lpeg}
\label{sec:bdxkrdxt}

\verb|LPeg| is a parser library for Lua.  The primary references for
the library are \textcite{bib:6whz1yt4} and \textcite{bib:rr7m3wo6}.
This section consists of some notes that I have made to learn about
the library.

\subsection{Strings}
\label{sec:hj8kx309}

A \firstterm{string} is an object of type \textsf{string}.  It is thus
a sequence of characters.  A \firstterm{character} is represented by a
byte, that is, an integer between 0 and 255 inclusive
\parencite[Section~2.1]{bib:x8gln9yb}.  The core library \verb|string|
provides basic facilities for working with strings.

A literal string (as opposed to a variable denoting a string) is
written within double quotes, with special characters escaped by a
backslash, as in \verb|"abc\"de"|.  The \firstterm{empty string} is
the literal string \verb|""|.  The concatenation of two strings is
given by the \verb|..| operator:
\begin{codechunk}
\nextchunklabel{chk:gzldnwzu}
<<lpegexam.lua>>=
assert("abc" .. "def" == "abcdef")
@
\end{codechunk}

The \firstterm{length} of the string, that is, the number of
characters in it, is given by the function \verb|string.len|:
\begin{codechunk}
\nextchunklabel{chk:bwsrb69b}
<<lpegexam.lua>>=
assert(string.len("abcde") == 5)
@
\end{codechunk}

The \verb|#| operator gives the length of any sequence, so it can be
used in the place of \verb|string.len|.  We can also call any function
in the core library \verb|string| as a method on strings, so we can
write \verb|s:len()| instead of \verb|string.len(s)|.  It is optional
to use parentheses around the argument when calling a function of one
argument that is a string or a table constructor.  Thus, the above
assertion could have been written in the following ways also:
\begin{codechunk}
\nextchunklabel{chk:ytfb0svk}
<<lpegexam.lua>>=
assert(# "abcde" == 5)
assert(("abcde"):len() == 5)
do
  local s = "abcde"
  assert(s:len() == 5)
end
assert(string.len "abcde" == 5)
assert(#("abcde") == 5)
@
\end{codechunk}

If \verb|s|. \verb|t|, and \verb|u| are strings such that \verb|s|
equals the concatenation \verb|t .. u|, we say that \verb|t| is a
\firstterm{prefix} of \texttt{s}, and \verb|u| a \firstterm{suffix} of
\verb|s|; in that case, \verb|s| and \verb|t| determine \verb|u|, and
\verb|s| and \verb|u| determine \verb|t|.

We say that a string \verb|t| is a \firstterm{substring} of a string
\verb|s| is \verb|s| equals \verb|u .. t .. v| for some strings
\verb|u| and \verb|v|.  In particular, the empty string \verb|""| and
\verb|s| are substrings of any string \verb|s|.

For every string \verb|s| of length \verb|n|, and for every integer
\verb|i| between \verb|1| and \verb|n| inclusive, we will denote the
character at position \verb|i| in \verb|s| by \verb||\verb|s[i]|; the
notation \verb|s[i]| is not a valid Lua expression; it is just a
convenient notation.

Subsequences of a string can be obtained using the function
\verb|string.sub|.  It takes a string \verb|s|, and two integers
\verb|i| and \verb|j| as arguments, and returns the substring of
\verb|s| that is determined by the following procedure, in which
\verb|n| denotes the length of \verb|s|:
\begin{enumerate}
\item The third argument \verb|j| is optional, and is given the value
  \verb|-1| if it is not supplied.
\item If \verb|i| \(<\) \verb|0|, it is substituted by
  \verb|n + i + 1|, and if \verb|j| \(<\) \verb|0|, it is substituted
  by \verb|n + j + 1|.
\item If \verb|i| \(<\) \verb|1|, it is substituted by \verb|1|, and
  if \verb|j| \(>\) \verb|n|, it is substituted by \verb|n|.
\item If \verb|i| \(>\) \verb|j|, the function returns the empty
  string \verb|""|.
\item If \verb|i| \(\leq\) \verb|j|, the function returns the
  substring of \verb|s| whose characters are \verb|s[i]|, \dots,
  \verb|s[j]| in that order.
\end{enumerate}

Here are some examples of using the function \verb|string.sub|.
\begin{codechunk}
\nextchunklabel{chk:wwsq6o3x}
<<lpegexam.lua>>=
do
  local s = "abcdef"
  assert(string.sub(s, -4, 3) == "c")
  assert(string.sub(s, 3, -2) == "cde")
  assert(string.sub(s, 3, 7) == "cdef")
  assert(string.sub(s, -7, -4) == "abc")
  assert(string.sub(s, 3, 2) == "")
  assert(string.sub(s, 3, 5) == "cde")
  assert(string.sub(s, 3) == "cdef")
end
@
\end{codechunk}

The function \texttt{string.byte} takes a string \texttt{s} and two
integers \verb|i| and \verb|j| as arguments, and returns multiple byte
values that are determined by the following procedure, in which
\verb|n| denotes the length of \verb|s|:
\begin{enumerate}
\item The second argument \verb|i| is optional, and is given the value
  \verb|1| if it is not supplied.
\item The third argument \verb|j| is optional, and is given the value
  \verb|i| if it is not supplied.
\item If \verb|i| \(<\) \verb|0|, it is substituted by
  \verb|n + i + 1|, and if \verb|j| \(<\) \verb|0|, it is substituted
  by \verb|n + j + 1|.
\item If \verb|i| \(<\) \verb|1|, it is substituted by \verb|1|, and
  if \verb|j| \(>\) \verb|n|, it is substituted by \verb|n|.
\item If \verb|i| \(>\) \verb|j|, the function returns no values.
\item If \verb|i| \(\leq\) \verb|j|, the function returns the bytes
  representing the characters \verb|s[i]|, \dots, \verb|s[j]| in that
  order.
\end{enumerate}

Here are some examples of using \verb|string.byte|.
\begin{codechunk}
\nextchunklabel{chk:38qzckgo}
<<lpegexam.lua>>=
do
  local s = "abcdef"
  local a1, e1 = {s:byte(1, 3)}, {97, 98, 99}
  local a2, e2 = {s:byte(2, 1)}, {}
  for k, v in pairs(a1) do
    assert(v == e1[k])
  end
  for k, v in pairs(a2) do
    assert(v == e2[k])
  end
end
@
\end{codechunk}
The last loop of assertions above says that the table \verb|a2| is
empty, that is, that the call \verb|s:byte(2,1)| returns no values.

\subsection{Patterns}
\label{sec:6sb55afv}

A \firstterm{pattern} is an object that specifies certain structural
properties of a general string.  We say that a pattern \verb|p|
\firstterm{matches} a string \verb|s| if \verb|s| has the properties
that are specified by \verb|p|.  The act of checking whether a pattern
\verb|p| matches a string \verb|s| is called \firstterm{matching}
\verb|s| against \verb|p|; in this context, \verb|s| is called the
\firstterm{subject}.

A pattern may associate certain values with every string that it
matches; such a pattern is called a \firstterm{capture pattern}.  The
values that a capture pattern \verb|p| associates with a string
\verb|s| that it matches are called the \firstterm{values captured}
from \verb|s| by \verb|p|, or the \firstterm{capture values} of
\verb|p| at \verb|s|.  I will call the patterns that are not capture
patterns \firstterm{liberal patterns}.

The \verb|lpeg| library provides a type \verb|pattern|, whose objects
represent patterns.  It also provides a function \verb|match| for
matching strings against patterns.

We import the \verb|lpeg| library with the name \verb|lpeg|.  This
means that any object exported by the library can be referenced by
prefixing \verb|lpeg| to its name.  In particular, \verb|lpeg.match|
refers to the function \verb|match| from the \verb|lpeg| library.
\begin{codechunk}
\nextchunklabel{chk:la3e982u}
<<lpegexam.lua>>=
local lpeg = require("lpeg")
@
\end{codechunk}

The function \verb|lpeg.match| takes a pattern \verb|p|, a string
\verb|s|, and an integer \verb|i|, and returns zero or more values
that are determined by the following procedure:
\begin{enumerate}
\item The third argument \verb|i| is optional, and is given the value
  \verb|1| if it is not supplied.
\item Let \verb|t| be the substring of \verb|s| that is the value
  returned by the function call \verb|string.sub(s, i)|, or,
  equivalently, by the function call \verb|string.sub(s, i, -1)|.
\item If the pattern \verb|p| does not match any prefix of the string
  \verb|t|, the function \verb|lpeg.match| returns the value
  \verb|nil|.
\item If \verb|p| matches a prefix of \verb|t|, and if \verb|p| is a
  liberal pattern, the function returns the integer \verb|i + k|,
  where \verb|k| is the length of the longest prefix of \verb|t| that
  \verb|p| matches.
\item If \verb|p| matches a prefix of \verb|t|, and if \verb|p| is a
  capture pattern, the function returns the values captured from
  \verb|t| by \verb|p|.
\end{enumerate}

A \emph{pattern} is a function
\(p : \mathcal{S} \to \mathcal{S} \cup \{\bot\}\) whose value at any
element \((s, i, \sigma)\) of \(\mathcal{S}\) is either \(\bot\), or
an element \((s', i', \sigma')\) of \(\mathcal{S}\) with the following
properties:
\begin{enumerate}
\item \(s' = s\);
\item \(i \leq i' \leq \ell(s) + 1\); and
\item \(\sigma\) is a subsequence of \(\sigma'\), that is,
  \begin{displaymath}
    \sigma = (t_1, \dotsc, t_m),
  \end{displaymath}
  and
  \begin{displaymath}
    \sigma' =
    (u_1, \dotsc, u_n, t_1, \dotsc, t_m, v_1, \dotsc, v_p),
  \end{displaymath}
  where \(m, n, p\) are natural numbers, and the \(t_i, u_j, v_k\) are
  substrings of \(s\).
\end{enumerate}

We say that a pattern \(p\) \emph{matches} an element \(x\) of
\(\mathcal{S}\) if \(p(x) \neq \bot\).  Thus, if \(p\) is a pattern
that matches an element \(x\) of \(\mathcal{S}\), then applying \(p\)
to \(x\) fixes the first coordinate of \(x\), and "enlarges" the
second and third coordinates of \(x\).

The \emph{match} function \(M\) takes a pattern \(p\), and an
element \(x = (s, i, \sigma)\) of \(\mathcal{S}\), and produces a
value \(M(p, x)\) as follows:
\begin{enumerate}
\item If \(p(x) = \bot\), then \(M(p, x) = \bot\).
\item If \(p(x) = (s, i', \sigma')\), where \(\sigma'\) is a nonempty
  sequence of substrings of \(s\), then \(M(p, x) = \sigma'\).
\item If \(p(x) = (s, i', ())\), then \(M(p, x) = i'\).
\end{enumerate}

\subsection{Basic patterns}
\label{sec:2ynr2sf4}

We describe here some basic ways of constructing patterns.  These
basic patterns can be combined using certain operators.

\subsubsection{String patterns}
\label{sec:zn6czomy}

If \(a\) is a string, we have a pattern \(p\), whose value at any
element \((s, i, \sigma)\) of \(\mathcal{S}\) is defined as follows:
\begin{itemize}
\item \(p((s, i, \sigma)) = (s, i + \ell(a), \sigma)\) if \(s = tav\),
  where \(t\) and \(v\) are strings such that \(\ell(t) = i - 1\); and
\item \(p((s, i, \sigma)) = \bot\) otherwise.
\end{itemize}
The pattern \(p\) is denoted by \(P(a)\).

For example, let \(a\) denote the string \(\str{hello}\), and \(p\)
the pattern \(P(a)\).  If \(s\) is the string \(\str{hello,␣world}\),
where the symbol ␣ indicates a space character, then
\begin{displaymath}
  p(s) =
  p((s, 1, ())) =
  (s, 1 + \ell(a), ()) =
  (s, 6, ())
\end{displaymath}
because \(s = tav\), where \(t = \varepsilon\), \(\ell(t) = 0\), and
\(v = \str{,␣world}\).  Similarly, if \(s\) is the string
\(\str{oh,␣hello,␣world}\), then
\begin{displaymath}
  p((s, 5, (\str{oh}, \str{wo})) = (s, 10, (\str{oh}, \str{wo})),
\end{displaymath}
and
\begin{displaymath}
  p(s) = p((s, 1, ())) = \bot.
\end{displaymath}

\subsubsection{Natural number patterns}
\label{sec:amrbrlnv}

If \(n\) is a natural number, we have a pattern \(p\), whose value at
any element \((s, i, \sigma)\) of \(\mathcal{S}\) is defined as
follows:
\begin{enumerate}
\item \(p((s, i, \sigma)) = (s, i + n, \sigma)\) if \(s = tuv\), where
  \(t\), \(u\), and \(v\) are strings such that \(\ell(t) = i - 1\)
  and \(\ell(u) = n\); and
\item \(p((s, i, \sigma)) = \bot\) otherwise.
\end{enumerate}
The pattern \(p\) is denoted by \(P(n)\).

For example, if \(p\) denotes the pattern \(P(3)\), and \(s\) the
string \(\str{\text{hello␣world}}\), then
\begin{align*}
  &p(s) = p(s, 1, ()) = (s, 4, ()), \\
  &p((s, 9, (\str{hell}, \str{wo}))) =
    (s, 12, (\str{hell}, \str{wo})), \\
  &p((s, 10, ())) = \bot.
\end{align*}

\subsubsection{Negative integer patterns}
\label{sec:upt2mdy9}

If \(n\) is a negative integer, we have a pattern \(p\), whose value
at any element \(x\) of \(\mathcal{S}\) is defined as follows:
\begin{enumerate}
\item \(p(x) = x\) if \(q(x) = \bot\), where \(q = P(-n)\); and
\item \(p(x) = \bot\) otherwise.
\end{enumerate}
The pattern \(p\) is denoted by \(P(n)\).

For example, if \(p\) denotes the pattern \(P(-3)\), and \(s\) the
string \(\str{\text{hello␣world}}\), then
\begin{align*}
  &p(s) = p(s, 1, ()) = \bot, \\
  &p((s, 9, (\str{hell}, \str{wo}))) = \bot, \\
  &p((s, 10, ())) = (s, 10, ()).
\end{align*}

\subsubsection{Boolean patterns}
\label{sec:kuf3y73z}

The symbols \(\mathsf{true}\) and \(\mathsf{false}\) lead to patterns
\(p\) and \(q\) that are defined by setting \(p(x) = x\) and
\(q(x) = \bot\) for all \(x \in \mathcal{S}\).  The pattern \(p\) is
denoted by \(P(\mathsf{true})\), and the pattern \(q\) by
\(P(\mathsf{false})\).

For example, if \(p\) denotes the pattern \(P(\mathsf{true})\), \(q\)
the pattern \(P(\mathsf{false})\), and \(s\) the string
\(\str{\text{hello␣world}}\), then
\begin{align*}
  &p(s) = s, \\
  &p((s, 9, (\str{hell}, \str{wo}))) =
    (s, 9, (\str{hell}, \str{wo})) \\
  &p((s, 10, ())) = (s, 10, ()),
\end{align*}
and
\begin{align*}
  &q(s) = \bot, \\
  &q((s, 9, (\str{hell}, \str{wo}))) = \bot, \\
  &q((s, 10, ())) = \bot.
\end{align*}

\subsubsection{Range patterns}
\label{sec:9vfw1yf3}

For any sequence \(\alpha\) of two-character strings, we have a
pattern \(p\), whose value at any element \((s, i, \sigma)\) of
\(\mathscr{S}\) is defined as follows:
\begin{enumerate}
\item \(p((s, i, \sigma)) = (s, i + 1, \sigma)\) if there are strings
  \(t, u, v\), and a member \(a = "c_1c_2"\) of the sequence
  \(\alpha\), such that \(s = tuv\), \(\ell(t) = i - 1\), and \(u\) is
  a one-character string whose sole character \(c\) satisfies the
  condition \(c_1 \leq c \leq c_2\) with respect to the standard order
  on the set of characters; and
\item \(p((s, i, \sigma)) = \bot\) otherwise.
\end{enumerate}
The pattern \(p\) is denoted by \(R(\alpha)\).

For example, if \(\alpha\) is the one-member sequence \(("09")\), and
\(p\) the pattern \(R(\alpha)\), then
\begin{align*}
  &p(\str{hello}) = p((\str{hello}, 1, ())) = \bot, \\
  &p((\str{hello,␣23B0}, 8, ())) = (\str{hello,␣23B0}, 9, ()), \\
  &p(\str{x86}) = p((\str{x86}, 1, ())) = \bot.
\end{align*}

\subsubsection{Set patterns}
\label{sec:zxaanwjq}

For any string \(a\), we have a pattern \(p\), whose value at any
element \((s, i, \sigma)\) of \(\mathscr{S}\) is defined as follows:
\begin{enumerate}
\item \(p((s, i, \sigma)) = (s, i + 1, \sigma)\) if \(s = tuv\), where
  \(t\), \(u\), and \(v\) are strings such that \(s = tuv\),
  \(\ell(t) = i - 1\), and \(u\) is a one-character string that is a
  substring of \(a\); and
\item \(p((s, i, \sigma)) = \bot\) otherwise.
\end{enumerate}
The pattern \(p\) is denoted by \(S(a)\).

For example, if \(a\) is the string \(\str{aeiou}\), and \(p\) the
pattern \(S(a)\), then
\begin{align*}
  &p(\str{hello}) = p((\str{hello}, 1, ())) = \bot, \\
  &p((\str{hello}, 2, ())) = (\str{hello}, 3, ()), \\
  &p(\str{aaa}) = p((\str{aaa}, 1, ())) = (\str{aaa}, 2, ()).
\end{align*}

\subsection{lpeg}
\label{sec:2pj8tomh}

I am using the Fennel programming language \parencite{bib:3jfp5s36} to
experiment with the \textsf{lpeg} library.  The code of the
experiments is in the file \filename{lpegexam.fnl}.  We first import
the library with the local name \textsf{lpeg}.
\begin{codechunk}
\nextchunklabel{chk:m5mv0tto}
<<lpegexam.fnl>>=
(local lpeg (require :lpeg))
@ %def lpeg
\end{codechunk}

In the \textsf{lpeg} library, the match function \(M\) is implemented
by the function \textsf{lpeg.match}:
\begin{flushleft}
  \textsf{lpeg.match pattern string [start]} \hfill
  [\textit{Function}]
\end{flushleft}
The first two arguments of the function are a pattern, and a string.
The third optional argument \textsf{start} is an integer such that
\begin{center}
  1 \(\leq\) \textsf{start} \(\leq\) \(\ell\)(\textsf{string}) + 1.
\end{center}
The default value of the third argument is \(1\).  The function
returns a value that represents the mathematical value
\begin{center}
  \textsf{M(pattern, ((string, start, ())))},
\end{center}
where \textsf{M} is the function described in \Cref{sec:6sb55afv}.
Thus:
\begin{enumerate}
\item If \textsf{pattern((string, start, ())) = \(\bot\)}, then
  \textsf{lpeg.match} returns the constant \textsf{nil}.
\item If \textsf{pattern((string, start, ())) = (string, index,
    \(\tau\))}, where the sequence \(\tau\) is a nonempty sequence of
  substrings of \textsf{string}, then \textsf{lpeg.match} returns the
  elements of \(\tau\) as multiple values.
\item If \textsf{pattern((string, start, ())) = (string, index, ())},
  then \textsf{lpeg.match} returns the integer \textsf{index}.
\end{enumerate}

The function \textsf{lpeg.match} is a method of the pattern object
that is its first argument.  This means that the function call
\begin{center}
  \textsf{(lpeg.match pattern string start)}
\end{center}
can also be written as
\begin{center}
  \textsf{(pattern:match string start)}.
\end{center}

\subsection{Basic patterns in lpeg}
\label{sec:7l3dfnco}

The \textsf{lpeg} equivalents of the basic patterns defined in
\Cref{sec:2ynr2sf4} are the topic of this subsection.  The library
does not give direct access to pattern objects, so I will describe
them by saying what the function \textsf{lpeg.match} does to the
patterns.

\subsubsection{String patterns}
\label{sec:lk201sc6}

For any string \textsf{string}, the function \textsf{lpeg.P} gives a
pattern \textsf{(lpeg.P~string)}.  This is the \textsf{lpeg}
equivalent of the string patterns of \Cref{sec:zn6czomy}.  It behaves
as follows under the action of \textsf{lpeg.match}.
\begin{codechunk}
\nextchunklabel{chk:furq3t6m}
<<lpegexam.fnl>>=
(let [p (lpeg.P "hello")]
  (assert (= (lpeg.match p "hello, world") 6))
  (assert (= (lpeg.match p "oh, hello world") nil))
  (assert (= (lpeg.match p "oh, hello world" 5) 10))
  (assert (= (lpeg.match p "hi world") nil)))
@
\end{codechunk}

When an \textsf{lpeg} function gets a string as an argument where it
expects a pattern, it applies the function \textsf{lpeg.P} to make a
pattern out of that string.  Therefore, we could have equivalently
written the above code as follows:
\begin{codechunk}
\nextchunklabel{chk:wm46f2zt}
<<lpegexam.fnl>>=
(let [p "hello"]
  (assert (= (lpeg.match p "hello, world") 6))
  (assert (= (lpeg.match p "oh, hello world") nil))
  (assert (= (lpeg.match p "oh, hello world" 5) 10))
  (assert (= (lpeg.match p "hi world") nil)))
@
\end{codechunk}

Using the method notation for \textsf{lpeg.match} that was mentioned
in \Cref{sec:2pj8tomh}, we can rewrite the above assertions as
follows:
\begin{codechunk}
\nextchunklabel{chk:rp4zttk5}
<<lpegexam.fnl>>=
(let [p (lpeg.P "hello")]
  (assert (= (p:match "hello, world") 6))
  (assert (= (p:match "oh, hello world") nil))
  (assert (= (p:match "oh, hello world" 5) 10))
  (assert (= (p:match "hi world") nil)))
@
\end{codechunk}

\subsubsection{Natural number patterns}
\label{sec:ptcsj9xp}

For any natural number \textsf{n}, \textsf{(lpeg.P~n)} is a pattern
that is the \textsf{lpeg} equivalent of the natural number patterns
described in \Cref{sec:amrbrlnv}.  It behaves as follows under the
action of \textsf{lpeg.match}.
\begin{codechunk}
\nextchunklabel{chk:dmqu1wqv}
<<lpegexam.fnl>>=
(let [p1 (lpeg.P 1)
      p3 (lpeg.P 3)]
  (assert (= (p1:match "") nil))
  (assert (= (p3:match "hello") 4))
  (assert (= (p3:match "hello" 3) 6)))
@
\end{codechunk}

\subsubsection{Negative integer patterns}
\label{sec:owdg0noo}

If \textsf{n} is a negative integer, then \textsf{(lpeg.P~n)} is a
pattern that is the \textsf{lpeg} version of the negative integer
patterns of \Cref{sec:upt2mdy9}.  Its behaviour under
\textsf{lpeg.match} is as under.
\begin{codechunk}
\nextchunklabel{chk:pb2cbgyw}
<<lpegexam.fnl>>=
(let [p1 (lpeg.P -1)
      p3 (lpeg.P -3)]
  (assert (= (p1:match "") 1))
  (assert (= (p3:match "hello") nil))
  (assert (= (p3:match "hello" 4) 4)))
@
\end{codechunk}

\subsubsection{Boolean patterns}
\label{sec:pzx44una}

If \textsf{b} is one of the Boolean constants \textsf{true} and
\textsf{false}, then \textsf{(lpeg.P~b)} is a pattern that is the
\textsf{lpeg} equivalent of the Boolean patterns of
\Cref{sec:kuf3y73z}.  Its behaviour under \textsf{lpeg.match} is as
follows.
\begin{codechunk}
\nextchunklabel{chk:xl0hd0u9}
<<lpegexam.fnl>>=
(let [p (lpeg.P true)
      q (lpeg.P false)]
  (assert (= (p:match "") 1))
  (assert (= (p:match "foo") 1))
  (assert (= (q:match "") nil))
  (assert (= (q:match "foo") nil)))
@
\end{codechunk}

\subsubsection{Range patterns}
\label{sec:lodb4xcu}

The pattern \textsf{(lpeg.P a1 a2 ...)} where \textsf{a1},
\textsf{a2}, \dots, are two-character strings corresponds in
\textsf{lpeg} to the range patterns defined in \Cref{sec:9vfw1yf3}.
They behave as follows with respect to \textsf{lpeg.match}.
\begin{codechunk}
\nextchunklabel{chk:btc0otpe}
<<lpegexam.fnl>>=
(let [p (lpeg.R "09")]
  (assert (= (p:match "hello") nil))
  (assert (= (p:match "879") 2))
  (assert (= (p:match "x86") nil)))
@
\end{codechunk}

The pattern \textsf{(lpeg.R "az" "AZ")} matches any Latin letter.
\begin{codechunk}
\nextchunklabel{chk:ggol2hsv}
<<lpegexam.fnl>>=
(let [p (lpeg.R "az" "AZ")]
  (assert (= (p:match "hello") 2))
  (assert (= (p:match "879") nil))
  (assert (= (p:match "86XF" 3) 4)))
@
\end{codechunk}

The pattern \textsf{(lpeg.R "af" "AF" "09")} matches any hexadecimal
digit.
\begin{codechunk}
\nextchunklabel{chk:97ounu5o}
<<lpegexam.fnl>>=
(let [p (lpeg.R "af" "AF" "09")]
  (assert (= (p:match "hello") nil))
  (assert (= (p:match "879") 2))
  (assert (= (p:match "Hiya23B0" 4) 5)))
@
\end{codechunk}

\subsubsection{Set patterns}
\label{sec:sghktf56}

The pattern \textsf{(lpeg.S~s)}, where \textsf{s} is any string, is
the \textsf{lpeg} equivalent of the set patterns that are described in
\Cref{sec:zxaanwjq}.  It behaves under the action of
\textsf{lpeg.match} as follows.
\begin{codechunk}
\nextchunklabel{chk:gnoa3lqr}
<<lpegexam.fnl>>=
(let [p (lpeg.S "aeiou")]
  (assert (= (p:match "hello") nil))
  (assert (= (p:match "all") 2))
  (assert (= (p:match "aaa") 2)))
@
\end{codechunk}

\bibsection

\nowebchunkssection

\nowebindexsection

\end{document}

%%% End of file

% Local Variables:
% tab-stop-list: (0 2)
% End:
